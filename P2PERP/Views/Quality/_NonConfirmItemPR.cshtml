<!-- Non-Confirm Item List Table Container -->
<div class="container mt-4 card shadow-sm">

    <div class="row align-items-center my-3">
        <!--  Date Range Picker (Left aligned) -->
        <div class="col-md-3">
            <div class="input-group" style="max-width: 280px;">
                <span class="input-group-text bg-primary text-white">
                    <i class="bi bi-calendar-event"></i>
                </span>
                <input type="text" id="Tabledate" class="form-control" readonly placeholder="Select Date Range" />
            </div>
        </div>

        <!--  Centered Heading -->
        <div class="col-md-6 text-center">
            <h4 class="mb-0 text-primary">Non-Confirm Item List</h4>
        </div>

        <!-- Empty right column (optional) -->
        <div class="col-md-3"></div>
    </div>


    <table id="Non-confirmItemTable" class="table table-striped table-bordered wrap" style="width:100%">
        <thead class="table-dark">
            <tr>
                <th><input type="checkbox" id="selectAllNonConfirm" class="small-checkbox" /></th>
                <th>Sr No</th>
                <th>GRN Code</th>
                <th>Vendor Name</th>
                <th>Add Date</th>
                <th class="dt-center ">Action</th>
            </tr>
        </thead>
    </table>
</div>

<!-- Bootstrap Modal for Viewing Details -->
<div class="modal fade" id="viewDetailsModal" tabindex="-1" aria-labelledby="viewDetailsModalLabel" aria-hidden="true" data-bs-backdrop="True">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <!-- Added modal-dialog-centered class -->
        <div class="modal-content">

            <!--  Modal Header with Centered Title -->
            <div class="modal-header bg-primary text-white justify-content-center py-3">
                <!-- Added py-3 for vertical padding -->
                <h5 class="modal-title text-white fw-bold text-center w-100" id="viewDetailsModalLabel">Non-Confirm Items</h5> <!-- Added text-center and w-100 -->
                <button type="button" class="btn-close btn-close-white position-absolute end-0me-1 mt-2 mb-2" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- GRN Code in Box -->
            <div class="px-4 py-3">
                <div class="border rounded bg-light p-2 d-inline-block">
                    <strong>GRN Code:</strong>
                    <span id="modalGRNCodeNonConfirm" class="text-black fw-bold"></span>
                </div>
            </div>

            <div class="modal-body">
                <!-- Export Buttons for Modal Table -->
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <div id="modalTableButtonsNonConfirm" class="btn-group"></div>
                    <!-- Search box removed from here -->
                </div>

                <!-- Dynamic Item Details Table -->
                <table class="table table-bordered" id="itemDetailsTableNonConfirm">
                    <thead class="table-dark">
                        <tr>
                            <th><input type="checkbox" id="selectAllItemDetails" class="small-checkbox" /></th>
                            <th>Sr No</th>
                            <th>Item Code</th>
                            <th>Item Name</th>
                            <th>Failure Reason</th>
                            <th>Failed QC Code</th>
                            <th>QualityCheackDate</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <div id="noDataMessageNonConfirm" class="text-center text-muted" style="display:none;">
                    No item details found for this GRN Code.
                </div>
            </div>
        </div>
    </div>
</div>


<style>
    h4 {
        font-weight: 600;
        margin-bottom: 0;
    }

    /* Optional spacing and alignment */
    div.dataTables_wrapper .dt-buttons {
        margin-bottom: 0 !important;
    }

    /* Center checkboxes */
    td.dt-center, th.dt-center {
        text-align: center;
        vertical-align: middle;
    }

    #itemDetailsTableNonConfirm th,
    #itemDetailsTableNonConfirm td {
        vertical-align: middle;
        text-align: center;
    }

    /* Table heading aur cell content center mein */
    #Non-confirmItemTable th,
    #Non-confirmItemTable td,
    #itemDetailsTableNonConfirm th,
    #itemDetailsTableNonConfirm td {
        text-align: center;
        vertical-align: middle !important;
    }

    /* ✅ SMALLER CHECKBOX STYLING FOR ALL CHECKBOXES */
    .small-checkbox {
        width: 14px !important;
        height: 14px !important;
        transform: scale(0.85);
        margin: 0 auto;
        display: block;
    }

    /* Ensure proper alignment for checkbox columns */
    #Non-confirmItemTable th:first-child,
    #Non-confirmItemTable td:first-child,
    #itemDetailsTableNonConfirm th:first-child,
    #itemDetailsTableNonConfirm td:first-child {
        width: 30px !important;
        text-align: center !important;
    }

    /* Modal positioning */
    .modal-dialog-centered {
        display: flex;
        align-items: center;
        min-height: calc(100% - 1rem);
    }

    button.dt-button.processing,
    div.dt-button.processing {
        pointer-events: auto !important;
        opacity: 1 !important;
        background: none !important;
    }

        button.dt-button.processing:after {
            content: none !important;
        }
</style>

<script>
    $(document).ready(function () {

        // Toastr Config
        toastr.options = {
            "closeButton": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "timeOut": "3000"
        };

        // ✅ UPDATED: Date Range Picker with DD-MM-YYYY format
        $('#Tabledate').daterangepicker({
            autoUpdateInput: false,
            alwaysShowCalendars: false,
            locale: {
                cancelLabel: 'Clear',
                format: 'DD-MM-YYYY',
                applyLabel: 'Apply',
                customRangeLabel: 'Custom Range'
            },
            ranges: {
                'Today': [moment(), moment()],
                'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                'Last 1 Month': [moment().subtract(1, 'months').startOf('day'), moment()],
                'Last 3 Months': [moment().subtract(3, 'months').startOf('day'), moment()],
                'Last 1 Year': [moment().subtract(12, 'months').startOf('day'), moment()]
            }
        }, function (start, end) {
            // Set the date range in the input field
            $('#Tabledate').val(start.format('DD-MM-YYYY') + ' - ' + end.format('DD-MM-YYYY'));

            // Store the dates in data attributes for filtering
            $('#Tabledate').data('start', start);
            $('#Tabledate').data('end', end);

            // Trigger table redraw
            $('#Non-confirmItemTable').DataTable().draw();
        });

        // Handle cancel event
        $('#Tabledate').on('cancel.daterangepicker', function () {
            $(this).val('Select Date Range');
            $(this).removeData('start').removeData('end');
            $('#Non-confirmItemTable').DataTable().draw();
        });

        // Set initial placeholder value
        $('#Tabledate').val('Select Date Range');

        // FIXED: Custom Search Filter for BOTH AddDate AND QualityCheckDate - UPDATED for DD-MM-YYYY
        $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
            if (settings.nTable.id !== 'Non-confirmItemTable') return true;

            const start = $('#Tabledate').data('start');
            const end = $('#Tabledate').data('end');

            // If no date range selected, show all rows
            if (!start || !end) return true;

            // Get both date columns
            const addDateStr = data[4]; // Add Date column (index 4)
            const qualityCheckDateStr = data[5]; // Quality Check Date column (index 5)

            //  Check if EITHER AddDate OR QualityCheckDate falls within the selected range
            let addDateInRange = false;
            let qualityCheckDateInRange = false;

            // Check Add Date - PRIORITIZE DD-MM-YYYY format
            if (addDateStr && addDateStr.trim() !== '') {
                const addDate = moment(addDateStr, ['DD-MM-YYYY', 'YYYY-MM-DD', 'MM/DD/YYYY', 'DD/MM/YYYY', 'YYYY/MM/DD'], true);
                if (addDate.isValid()) {
                    addDateInRange = addDate.isSameOrAfter(start) && addDate.isSameOrBefore(end);
                }
            }

            // Check Quality Check Date - PRIORITIZE DD-MM-YYYY format
            if (qualityCheckDateStr && qualityCheckDateStr.trim() !== '') {
                const qualityCheckDate = moment(qualityCheckDateStr, ['DD-MM-YYYY', 'YYYY-MM-DD', 'MM/DD/YYYY', 'DD/MM/YYYY', 'YYYY/MM/DD'], true);
                if (qualityCheckDate.isValid()) {
                    qualityCheckDateInRange = qualityCheckDate.isSameOrAfter(start) && qualityCheckDate.isSameOrBefore(end);
                }
            }

            //  Return true if EITHER date falls within the range
            return addDateInRange || qualityCheckDateInRange;
        });

        // 🔹 Main DataTable Initialization
        var table = $('#Non-confirmItemTable').DataTable({
            processing: true,
            serverSide: false,
            responsive: true,
            dom: '<"d-flex justify-content-between align-items-center mb-2"Bf>rt<"d-flex justify-content-between align-items-center mt-2"ip>',
            ajax: {
                url: '@Url.Action("nonConfirmItemsPR", "Quality")',
                type: "GET",
                datatype: "json",
                error: function (xhr) {
                    console.log("Ajax Error:", xhr.responseText);
                    alert("Error: " + xhr.status + " - " + xhr.statusText);
                }
            },
            columns: [
                {
                    data: null,
                    orderable: false,
                    searchable: false,
                    className: 'dt-center',
                    render: function (data, type, row) {
                        return `<input type="checkbox" class="row-select small-checkbox" value="${row.GRNCode}" />`;
                    }
                },
                {
                    data: null,
                    title: 'Sr No',
                    orderable: false ,
                    className: 'dt-center',
                    render: function (data, type, row, meta) {
                        return meta.row + 1;
                    }
                },
                { data: "GRNCode", orderable: false, className: "dt-center" },
                { data: "VenderName", orderable: false, className: "dt-center" },
                { data: "AddDate", orderable: false, className: "dt-center" },
                {
                    data: null,
                    className: "dt-center",
                    orderable: false,
                    render: function (data, type, row) {
                        return `<button class="btn btn-sm btn-primary view-details-btn"
                data-grn="${row.GRNCode}"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="View Details">
            <i class="bi bi-eye-fill"></i>
        </button>`;
                    }
                }
            ],
            buttons: [

                // PRINT - Main Table
                {
                    extend: 'print',
                    text: '<i class="bi bi-printer-fill text-dark fs-5"></i>',
                    title: '', // ✅ Empty title to remove default table title
                    exportOptions: {
                        rows: function (idx, data, node) {
                            return $(node).find('.row-select').prop('checked');
                        },
                        columns: ':not(:first-child):not(:last-child)',
                        format: {
                            body: function (data, row, column, node) {
                                // ✅ Sequential serial numbers for selected rows
                                if (column === 1) { // Sr No column (index 1)
                                    const $node = $(node);
                                    if ($node.closest('tr').find('.row-select').prop('checked')) {
                                        const selectedRows = $('#Non-confirmItemTable tbody input.row-select:checked');
                                        const currentRow = $node.closest('tr');
                                        const currentIndex = selectedRows.index(currentRow.find('.row-select'));
                                        return currentIndex + 1; // Sequential number
                                    }
                                    return ''; // Empty for non-selected
                                }
                                return data;
                            }
                        }
                    },
                    action: function (e, dt, button, config) {
                        const selected = $('input.row-select:checked').length;
                        if (selected === 0) {
                            toastr.warning('Please select at least one row before exporting.');
                            return;
                        }
                        $.fn.dataTable.ext.buttons.print.action.call(this, e, dt, button, config);
                    },
                    customize: function (win) {
                        var $body = $(win.document.body);

                        $body.append(`
            <style>
                thead th {
                    background-color: black !important;
                    color: white !important;
                    text-align: center !important;
                }
                table {
                    border-collapse: collapse !important;
                    width: 100% !important;
                }
                td, th {
                    border: 1px solid #000 !important;
                    padding: 6px !important;
                    text-align: center !important;
                }
                .centered-content {
                    text-align: center !important;
                }
            </style>
        `);

                        // ✅ FIXED: Single header with title and date - TABLE KE UPAR EK HI BAR
                        $body.prepend(`
            <div style="text-align: center; margin-bottom: 20px;">
                <h2>Non-Confirm Item List</h2>
                <p>Generated on: ${moment().format("DD/MM/YYYY")}</p>
            </div>
        `);

                        // ✅ Center align all content in print
                        $body.find('table').addClass('centered-content');
                        $body.find('td, th').css('text-align', 'center');

                        // ✅ Fix serial numbers in print - sequential for selected rows only
                        const $table = $body.find('table');
                        let serialNo = 1;
                        $table.find('tbody tr').each(function () {
                            const $row = $(this);
                            $row.find('td:first').text(serialNo++);
                        });

                        // ✅ REMOVE DUPLICATE TITLE THAT APPEARS ABOVE TABLE
                        $body.find('h1').remove(); // DataTable default title remove
                    }
                },

                // PDF - Main Table
                {
                    extend: 'pdfHtml5',
                    text: '<i class="bi bi-file-earmark-pdf text-danger fs-5"></i>',
                    title: 'Non-Confirm Item List',
                    exportOptions: {
                        rows: function (idx, data, node) {
                            return $(node).find('.row-select').prop('checked');
                        },
                        columns: ':not(:first-child):not(:last-child)',
                        format: {
                            body: function (data, row, column, node) {
                                // ✅ Sequential serial numbers for selected rows
                                if (column === 1) { // Sr No column
                                    const $node = $(node);
                                    if ($node.closest('tr').find('.row-select').prop('checked')) {
                                        const selectedRows = $('#Non-confirmItemTable tbody input.row-select:checked');
                                        const currentRow = $node.closest('tr');
                                        const currentIndex = selectedRows.index(currentRow.find('.row-select'));
                                        return currentIndex + 1;
                                    }
                                    return '';
                                }
                                return data;
                            }
                        }
                    },
                    action: function (e, dt, button, config) {
                        const selected = $('input.row-select:checked').length;
                        if (selected === 0) {
                            toastr.warning('Please select at least one row before exporting.');
                            return;
                        }
                        $.fn.dataTable.ext.buttons.pdfHtml5.action.call(this, e, dt, button, config);
                    },
                    customize: function (doc) {
                        doc.pageMargins = [40, 60, 40, 40]; // Reduced top margin

                        // ✅ FIXED: Single title with generated date
                        doc.content[0] = {
                            text: 'Non-Confirm Item List\nGenerated on: ' + moment().format("DD/MM/YYYY"),
                            alignment: 'center',
                            margin: [0, 0, 0, 10],
                            fontSize: 14,
                            bold: true
                        };

                        const table = doc.content.find(n => n.table);
                        if (table) {
                            table.table.widths = Array(table.table.body[0].length).fill('*');
                            table.layout = {
                                hLineWidth: () => 0.5,
                                vLineWidth: () => 0.5,
                                hLineColor: () => '#aaa',
                                vLineColor: () => '#aaa',
                                fillColor: (i) => i === 0 ? '#343a40' : null,
                                paddingLeft: () => 5,
                                paddingRight: () => 5
                            };

                            // Style header row
                            table.table.body[0].forEach(cell => {
                                cell.fillColor = '#343a40';
                                cell.color = 'white';
                                cell.alignment = 'center';
                                cell.fontSize = 11;
                                cell.bold = true;
                            });

                            // ✅ Center align all cells and fix serial numbers
                            let serialNo = 1;
                            table.table.body.forEach((row, rowIndex) => {
                                if (rowIndex > 0) {
                                    row[0].text = serialNo++; // Sequential serial number
                                }
                                row.forEach(cell => {
                                    cell.alignment = 'center'; // Center align all cells
                                });
                            });

                            table.alignment = 'center';
                        }

                        // Set default alignment for all content
                        doc.defaultStyle = {
                            alignment: 'center'
                        };
                    }
                },

                // ✅ EXCEL - Main Table (UPDATED: Sr. No column और center alignment)
                {
                    extend: 'excelHtml5',
                    text: '<i class="bi bi-file-earmark-excel text-success fs-5"></i>',
                    title: 'Non-Confirm Item List',
                    messageTop: `Generated Date: ${moment().format("DD/MM/YYYY")}`,
                    exportOptions: {
                        rows: function (idx, data, node) {
                            return $(node).find('.row-select').prop('checked');
                        },
                        columns: ':not(:first-child):not(:last-child)',
                        format: {
                            body: function (data, row, column, node) {
                                if (column === 1) {
                                    const $node = $(node);
                                    if ($node.closest('tr').find('.row-select').prop('checked')) {
                                        const selectedRows = $('#Non-confirmItemTable tbody input.row-select:checked');
                                        const currentRow = $node.closest('tr');
                                        const currentIndex = selectedRows.index(currentRow.find('.row-select'));
                                        return currentIndex + 1;
                                    }
                                    return '';
                                }
                                return data;
                            }
                        }
                    },
                    customize: function (xlsx) {
                        let sheet = xlsx.xl.worksheets['sheet1.xml'];

                        // Insert "Sr. No" column at start and make it bold
                        let serial = 1;
                        $('row', sheet).each(function () {
                            let rowIndex = parseInt($(this).attr('r'));

                            if (rowIndex === 1) {
                                // Title row - center align and bold
                                $(this).find('c').attr('s', '51');
                            } else if (rowIndex === 2) {
                                // Generated date row - center align and bold
                                $(this).find('c').attr('s', '51');
                            } else if (rowIndex === 3) {
                                // Header row: Add Sr. No column
                                $(this).find('c:first').before(`<c t="inlineStr" s="2"><is><t>Sr. No</t></is></c>`);
                                // Make all header cells bold and centered
                                $(this).find('c').attr('s', '2');
                            } else if (rowIndex > 3) {
                                // Data rows: Add serial numbers
                                $(this).find('c:first').before(`<c t="inlineStr"><is><t>${serial}</t></is></c>`);
                                serial++;
                            }
                        });

                        // Center align title and date rows
                        $('row[r="1"] c', sheet).attr('s', '51');
                        $('row[r="2"] c', sheet).attr('s', '51');
                    },
                    action: function (e, dt, button, config) {
                        const selected = $('input.row-select:checked').length;
                        if (selected === 0) {
                            toastr.warning('Please select at least one row before exporting.');
                            return;
                        }
                        $.fn.dataTable.ext.buttons.excelHtml5.action.call(this, e, dt, button, config);
                    }
                },

                // CSV - Main Table (UPDATED: Title और Generated Date अलग-अलग)
                {
                    extend: 'csvHtml5',
                    text: '<i class="bi bi-filetype-csv text-success fs-5"></i>',
                    title: 'Non-Confirm Item List', // ✅ Title अलग
                    message: 'Generated on: ' + moment().format("DD/MM/YYYY"), // ✅ Generated date अलग
                    exportOptions: {
                        rows: function (idx, data, node) {
                            return $(node).find('.row-select').prop('checked');
                        },
                        columns: ':not(:first-child):not(:last-child)',
                        format: {
                            body: function (data, row, column, node) {
                                // ✅ Sequential serial numbers for selected rows
                                if (column === 1) { // Sr No column
                                    const $node = $(node);
                                    if ($node.closest('tr').find('.row-select').prop('checked')) {
                                        const selectedRows = $('#Non-confirmItemTable tbody input.row-select:checked');
                                        const currentRow = $node.closest('tr');
                                        const currentIndex = selectedRows.index(currentRow.find('.row-select'));
                                        return currentIndex + 1;
                                    }
                                    return '';
                                }
                                return data;
                            }
                        }
                    },
                    action: function (e, dt, button, config) {
                        const selected = $('input.row-select:checked').length;
                        if (selected === 0) {
                            toastr.warning('Please select at least one row before exporting.');
                            return;
                        }
                        $.fn.dataTable.ext.buttons.csvHtml5.action.call(this, e, dt, button, config);
                    }
                }
            ]
        });

        // Initialize Bootstrap tooltips on page load
        $('body').tooltip({
            selector: '[data-bs-toggle="tooltip"]'
        });

        // Re-initialize tooltips on every DataTable draw
        $('#Non-confirmItemTable').on('draw.dt', function () {
            $('[data-bs-toggle="tooltip"]').tooltip();
        });

        // 🔹 Select/Deselect All Rows in Main Table
        $('#selectAllNonConfirm').on('click', function () {
            $('.row-select').prop('checked', this.checked);
        });

        $('#Non-confirmItemTable tbody').on('change', '.row-select', function () {
            const allChecked = $('.row-select').length === $('.row-select:checked').length;
            $('#selectAllNonConfirm').prop('checked', allChecked);
        });

        // 🔹 Modal View: Fetch Details via AJAX
        $('#Non-confirmItemTable').on('click', '.view-details-btn', function () {
            const grnCode = $(this).data('grn');
            $('#modalGRNCodeNonConfirm').text(grnCode);
            const tbody = $('#itemDetailsTableNonConfirm tbody');
            tbody.empty().append('<tr><td colspan="7" class="text-center">Loading...</td></tr>');
            $('#noDataMessageNonConfirm').hide();

            $.ajax({
                url: '@Url.Action("FailedItemsDetailsPR", "Quality")',
                type: 'GET',
                data: { grnCode },
                success: function (response) {
                    tbody.empty();

                    if ($.fn.DataTable.isDataTable('#itemDetailsTableNonConfirm')) {
                        $('#itemDetailsTableNonConfirm').DataTable().clear().destroy();
                    }
                    $('#modalTableButtonsNonConfirm').empty();
                    $('#selectAllItemDetails').prop('checked', false);

                    if (response.success && response.data.length > 0) {
                        response.data.forEach((item, i) => {
                            tbody.append(`
                                <tr>
                                    <td class="dt-center"><input type="checkbox" class="item-row-select small-checkbox" value="${item.ItemCode}" /></td>
                                    <td class="dt-center">${i + 1}</td>
                                    <td class="dt-center">${item.ItemCode}</td>
                                    <td class="dt-center">${item.ItemName}</td>
                                    <td class="dt-center">${item.Reason}</td>
                                    <td class="dt-center">${item.FailedQCCode}</td>
                                    <td class="dt-center">${item.AddedDate}</td>
                                </tr>
                            `);
                        });

                        const modalTable = $('#itemDetailsTableNonConfirm').DataTable({
                            paging: true,
                            searching: true,
                            ordering: false,
                            lengthChange: false,
                            pageLength: 5,
                            responsive: true,
                            dom: '<"d-flex justify-content-end align-items-center mb-2"Bf>rt<"d-flex justify-content-between align-items-center mt-2"ip>',
                            language: {
                                search: "Search:"
                            },
                            buttons: [
                                // ✅ PRINT - Modal Table
                                {
                                    extend: 'print',
                                    text: '<i class="bi bi-printer-fill text-dark fs-6"></i>',
                                    title: '',
                                    exportOptions: {
                                        rows: function (idx, data, node) {
                                            return $(node).find('.item-row-select').prop('checked');
                                        },
                                        columns: ':not(:first-child)',
                                        format: {
                                            body: function (data, row, column, node) {
                                                // ✅ Sequential serial numbers for selected modal items
                                                if (column === 1) { // Sr No column
                                                    const $node = $(node);
                                                    if ($node.closest('tr').find('.item-row-select').prop('checked')) {
                                                        const selectedRows = $('.item-row-select:checked');
                                                        const currentRow = $node.closest('tr');
                                                        const currentIndex = selectedRows.index(currentRow.find('.item-row-select'));
                                                        return currentIndex + 1;
                                                    }
                                                    return '';
                                                }
                                                return data;
                                            }
                                        }
                                    },
                                    action: function (e, dt, button, config) {
                                        const selected = $('.item-row-select:checked').length;
                                        if (selected === 0) {
                                            toastr.warning('Please select at least one item to export.');
                                            return;
                                        }
                                        $.fn.dataTable.ext.buttons.print.action.call(this, e, dt, button, config);
                                    },
                                    customize: function (win) {
                                        var $body = $(win.document.body);

                                        $body.append(`
                    <style>
                        thead th {
                            background-color: black !important;
                            color: white !important;
                            text-align: center !important;
                        }
                        table {
                            border-collapse: collapse !important;
                            width: 100% !important;
                        }
                        td, th {
                            border: 1px solid #000 !important;
                            padding: 6px !important;
                            text-align: center !important;
                        }
                        .centered-content {
                            text-align: center !important;
                        }
                    </style>
                `);

                                        // ✅ FIXED: Single header for modal
                                        $body.prepend(`
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h2>Failed Items Details - ${$('#modalGRNCodeNonConfirm').text()}</h2>
                        <p>Generated on: ${moment().format("DD/MM/YYYY")}</p>
                    </div>
                `);

                                        // ✅ Center align all content in print
                                        $body.find('table').addClass('centered-content');
                                        $body.find('td, th').css('text-align', 'center');

                                        // ✅ Fix serial numbers in modal print
                                        const $table = $body.find('table');
                                        let serialNo = 1;
                                        $table.find('tbody tr').each(function () {
                                            const $row = $(this);
                                            $row.find('td:first').text(serialNo++);
                                        });
                                    }
                                },

                                // ✅ PDF - Modal Table
                                {
                                    extend: 'pdfHtml5',
                                    text: '<i class="bi bi-file-earmark-pdf text-danger fs-6"></i>',
                                    title: 'Failed Items Details',
                                    exportOptions: {
                                        rows: function (idx, data, node) {
                                            return $(node).find('.item-row-select').prop('checked');
                                        },
                                        columns: ':not(:first-child)',
                                        format: {
                                            body: function (data, row, column, node) {
                                                // ✅ Sequential serial numbers for selected modal items
                                                if (column === 1) { // Sr No column
                                                    const $node = $(node);
                                                    if ($node.closest('tr').find('.item-row-select').prop('checked')) {
                                                        const selectedRows = $('.item-row-select:checked');
                                                        const currentRow = $node.closest('tr');
                                                        const currentIndex = selectedRows.index(currentRow.find('.item-row-select'));
                                                        return currentIndex + 1;
                                                    }
                                                    return '';
                                                }
                                                return data;
                                            }
                                        }
                                    },
                                    action: function (e, dt, button, config) {
                                        const selected = $('.item-row-select:checked').length;
                                        if (selected === 0) {
                                            toastr.warning('Please select at least one item to export.');
                                            return;
                                        }
                                        $.fn.dataTable.ext.buttons.pdfHtml5.action.call(this, e, dt, button, config);
                                    },
                                    customize: function (doc) {
                                        doc.pageMargins = [40, 80, 40, 40]; // Reduced top margin

                                        // ✅ FIXED: Single title for modal PDF
                                        doc.content[0] = {
                                            text: `Failed Items Details - ${$('#modalGRNCodeNonConfirm').text()}\nGenerated on: ${moment().format("DD/MM/YYYY")}`,
                                            alignment: 'center',
                                            margin: [0, 0, 0, 10],
                                            fontSize: 14,
                                            bold: true
                                        };

                                        const table = doc.content.find(n => n.table);
                                        if (table) {
                                            table.table.widths = Array(table.table.body[0].length).fill('*');
                                            table.layout = {
                                                hLineWidth: () => 0.5,
                                                vLineWidth: () => 0.5,
                                                hLineColor: () => '#aaa',
                                                vLineColor: () => '#aaa',
                                                fillColor: (i) => i === 0 ? '#343a40' : null,
                                                paddingLeft: () => 5,
                                                paddingRight: () => 5
                                            };

                                            // Style header row
                                            table.table.body[0].forEach(cell => {
                                                cell.fillColor = '#343a40';
                                                cell.color = 'white';
                                                cell.alignment = 'center';
                                                cell.fontSize = 11;
                                                cell.bold = true;
                                            });

                                            // ✅ Center align all cells and fix serial numbers
                                            let serialNo = 1;
                                            table.table.body.forEach((row, rowIndex) => {
                                                if (rowIndex > 0) {
                                                    row[0].text = serialNo++;
                                                }
                                                row.forEach(cell => {
                                                    cell.alignment = 'center'; // Center align all cells
                                                });
                                            });

                                            table.alignment = 'center';
                                        }

                                        // Set default alignment for all content
                                        doc.defaultStyle = {
                                            alignment: 'center'
                                        };
                                    }
                                },

                                // ✅ EXCEL - Modal Table (UPDATED: Sr. No column और center alignment)
                                {
                                    extend: 'excelHtml5',
                                    text: '<i class="bi bi-file-earmark-excel text-success fs-6"></i>',
                                    title: 'Failed Items Details - ' + $('#modalGRNCodeNonConfirm').text(),
                                    messageTop: `Generated Date: ${moment().format("DD/MM/YYYY")}`,
                                    exportOptions: {
                                        rows: function (idx, data, node) {
                                            return $(node).find('.item-row-select').prop('checked');
                                        },
                                        columns: ':not(:first-child)',
                                        format: {
                                            body: function (data, row, column, node) {
                                                if (column === 1) {
                                                    const $node = $(node);
                                                    if ($node.closest('tr').find('.item-row-select').prop('checked')) {
                                                        const selectedRows = $('.item-row-select:checked');
                                                        const currentRow = $node.closest('tr');
                                                        const currentIndex = selectedRows.index(currentRow.find('.item-row-select'));
                                                        return currentIndex + 1;
                                                    }
                                                    return '';
                                                }
                                                return data;
                                            }
                                        }
                                    },
                                    customize: function (xlsx) {
                                        let sheet = xlsx.xl.worksheets['sheet1.xml'];

                                        // Insert "Sr. No" column at start and make it bold
                                        let serial = 1;
                                        $('row', sheet).each(function () {
                                            let rowIndex = parseInt($(this).attr('r'));

                                            if (rowIndex === 1) {
                                                // Title row - center align and bold
                                                $(this).find('c').attr('s', '51');
                                            } else if (rowIndex === 2) {
                                                // Generated date row - center align and bold
                                                $(this).find('c').attr('s', '51');
                                            } else if (rowIndex === 3) {
                                                // Header row: Add Sr. No column
                                                $(this).find('c:first').before(`<c t="inlineStr" s="2"><is><t>Sr. No</t></is></c>`);
                                                // Make all header cells bold and centered
                                                $(this).find('c').attr('s', '2');
                                            } else if (rowIndex > 3) {
                                                // Data rows: Add serial numbers
                                                $(this).find('c:first').before(`<c t="inlineStr"><is><t>${serial}</t></is></c>`);
                                                serial++;
                                            }
                                        });

                                        // Center align title and date rows
                                        $('row[r="1"] c', sheet).attr('s', '51');
                                        $('row[r="2"] c', sheet).attr('s', '51');
                                    },
                                    action: function (e, dt, button, config) {
                                        const selected = $('.item-row-select:checked').length;
                                        if (selected === 0) {
                                            toastr.warning('Please select at least one item to export.');
                                            return;
                                        }
                                        $.fn.dataTable.ext.buttons.excelHtml5.action.call(this, e, dt, button, config);
                                    }
                                },

                                // CSV - Modal Table (UPDATED: Title और Generated Date अलग-अलग)
                                {
                                    extend: 'csvHtml5',
                                    text: '<i class="bi bi-filetype-csv text-success fs-6"></i>',
                                    title: 'Failed Items Details - ' + $('#modalGRNCodeNonConfirm').text(), // ✅ Title अलग
                                    message: 'Generated on: ' + moment().format("DD/MM/YYYY"), // ✅ Generated date अलग
                                    exportOptions: {
                                        rows: function (idx, data, node) {
                                            return $(node).find('.item-row-select').prop('checked');
                                        },
                                        columns: ':not(:first-child)',
                                        format: {
                                            body: function (data, row, column, node) {
                                                // ✅ Sequential serial numbers for selected modal items
                                                if (column === 1) { // Sr No column
                                                    const $node = $(node);
                                                    if ($node.closest('tr').find('.item-row-select').prop('checked')) {
                                                        const selectedRows = $('.item-row-select:checked');
                                                        const currentRow = $node.closest('tr');
                                                        const currentIndex = selectedRows.index(currentRow.find('.item-row-select'));
                                                        return currentIndex + 1;
                                                    }
                                                    return '';
                                                }
                                                return data;
                                            }
                                        }
                                    },
                                    action: function (e, dt, button, config) {
                                        const selected = $('.item-row-select:checked').length;
                                        if (selected === 0) {
                                            toastr.warning('Please select at least one item to export.');
                                            return;
                                        }
                                        $.fn.dataTable.ext.buttons.csvHtml5.action.call(this, e, dt, button, config);
                                    }
                                }
                            ],
                            initComplete: function () {
                                // Buttons aur search box ko align karne ke liye
                                $('.dataTables_filter').addClass('ms-3');
                            }
                        });
                        modalTable.buttons().container().appendTo('#modalTableButtonsNonConfirm');

                        // Modal checkbox logic
                        $('#selectAllItemDetails').on('click', function () {
                            $('.item-row-select').prop('checked', this.checked);
                        });

                        $('#itemDetailsTableNonConfirm tbody').on('change', '.item-row-select', function () {
                            const total = $('.item-row-select').length;
                            const selected = $('.item-row-select:checked').length;
                            $('#selectAllItemDetails').prop('checked', total === selected);
                        });

                    } else {
                        $('#noDataMessageNonConfirm').show();
                    }
                },
                error: function (xhr) {
                    tbody.empty().append('<tr><td colspan="7" class="text-danger text-center">Failed to load item details.</td></tr>');
                }
            });

            new bootstrap.Modal(document.getElementById('viewDetailsModal')).show();
        });

        //  Debug function to check date formats
        table.on('draw', function () {
            console.log('Table redrawn with date filter');
            const start = $('#Tabledate').data('start');
            const end = $('#Tabledate').data('end');
            if (start && end) {
                console.log('Active date filter:', {
                    start: start.format('DD-MM-YYYY'),
                    end: end.format('DD-MM-YYYY')
                });
            }
        });

    });
</script>